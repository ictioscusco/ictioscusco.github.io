<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>IcTiosCusco — Donaciones</title>
    <meta name="description" content="Apoya a IcTiosCusco: dona para investigación, compra merch y ayuda a conservar Orestias y lagunas altoandinas." />

    <link href="https://fonts.googleapis.com/css?family=Dosis:200,300,400,500,700" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Overpass:300,400,400i,600,700" rel="stylesheet" />

    <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css" />
    <link rel="stylesheet" href="css/animate.css" />
    <link rel="stylesheet" href="css/owl.carousel.min.css" />
    <link rel="stylesheet" href="css/owl.theme.default.min.css" />
    <link rel="stylesheet" href="css/magnific-popup.css" />
    <link rel="stylesheet" href="css/aos.css" />
    <link rel="stylesheet" href="css/ionicons.min.css" />
    <link rel="stylesheet" href="css/bootstrap-datepicker.css" />
    <link rel="stylesheet" href="css/jquery.timepicker.css" />
    <link rel="stylesheet" href="css/flaticon.css" />
    <link rel="stylesheet" href="css/icomoon.css" />
    <link rel="stylesheet" href="css/style.css" />

    <style>
      /* ---------- Visual adjustments ---------- */
      body { font-family: "Overpass", "Dosis", sans-serif; background: #f8fafb; color:#0e2a39; }
      .container { max-width:1200px; margin:0 auto; padding:18px; }
      .navbar-brand img { height:56px; margin-right:12px; }

      .hero-wrap { background-size:cover; background-position:center; padding:36px 0; margin-bottom:18px; border-radius:8px; color:#fff; background-image:url('images/donate_hero.jpg'); }

      .donate-panel { background:#fff; border-radius:10px; padding:20px; box-shadow:0 10px 30px rgba(16,24,40,0.06); margin-bottom:28px; }

      /* Inputs & textarea contrast (FIX) */
      .form-control {
        background: #f3fbfc !important;      /* light tinted background so text is visible */
        color: #06323a !important;           /* dark teal text for contrast */
        border: 1px solid #d1e8ea !important;
        padding: 10px 12px;
        border-radius: 6px;
        box-shadow: none !important;
      }
      .form-control:focus {
        outline: none;
        border-color: #0b6b6b !important;
        box-shadow: 0 6px 18px rgba(6,50,58,0.06);
      }
      textarea.form-control { min-height:110px; resize:vertical; }

      /* Placeholder color */
      ::placeholder { color: rgba(6,50,58,0.4); }

      /* QR image */
      .qr-box {
        text-align:center;
        background:#fff;
        border-radius:10px;
        padding:12px;
        box-shadow:0 8px 24px rgba(16,24,40,0.04);
        margin-top:12px;
      }
      .qr-img { width:100%; max-width:260px; height:auto; display:block; margin:10px auto; border-radius:8px; border:1px solid #e6f2f3; box-shadow:0 6px 18px rgba(6,50,58,0.04); }
      .qr-caption { font-size:0.95rem; color:#06323a; font-weight:600; margin-top:6px; }

      /* Merch & cart styles (keep consistent) */
      .merch-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:18px; }
      .merch-card { background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 8px 24px rgba(16,24,40,0.06); display:flex; flex-direction:column; }
      .merch-card img { width:100%; height:220px; object-fit:cover; display:block; }
      .cart { background:#fff; border-radius:10px; padding:14px; box-shadow:0 8px 24px rgba(16,24,40,0.04); }

      button.btn { cursor:pointer; }

      @media (max-width:575px) {
        .hero-wrap { padding:24px 12px; }
        .merch-card img { height:160px; }
        .qr-img { max-width:200px; }
      }
    </style>
  </head>

  <body>
    <!-- NAV -->
    <nav style="background:#06323a; padding:10px 0; color:#fff;">
      <div class="container" style="display:flex; align-items:center;">
        <a href="index.html" style="display:flex; align-items:center; text-decoration:none; color:inherit;">
          <img src="images/logo.png" alt="IcTiosCusco logo" />
          <span style="font-weight:700; margin-left:6px;">IcTiosCusco</span>
        </a>
      </div>
    </nav>

    <div class="container">
      <!-- HERO -->
      <div class="hero-wrap" role="img" aria-label="Apoya IcTiosCusco">
        <div style="max-width:900px; margin:0 auto; text-align:center; padding:40px 18px;">
          <h1 style="margin:0 0 8px; font-weight:700;">Apoya nuestro trabajo</h1>
          <p style="margin:0; font-size:1.05rem;">Tu aporte mantiene muestreos, análisis genéticos y talleres con comunidades. Gracias.</p>
        </div>
      </div>

      <!-- CONTENT -->
      <div style="display:flex; gap:18px; flex-wrap:wrap;">
        <div style="flex:1 1 680px; min-width:300px;">
          <!-- Donación rápida -->
          <div class="donate-panel">
            <h3 style="margin-top:0;">Donar ahora</h3>

            <div id="sandbox-note" class="sandbox-banner" style="display:none;">Modo sandbox activo — los pagos son de prueba.</div>

            <p>Elige un monto o escribe el que desees. Se abrirá PayPal para completar el pago.</p>

            <div style="margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-outline-primary quick-amount" data-amount="10">$ 10</button>
              <button class="btn btn-outline-primary quick-amount" data-amount="25">$ 25</button>
              <button class="btn btn-outline-primary quick-amount" data-amount="50">$ 50</button>
              <button class="btn btn-outline-primary quick-amount" data-amount="100">$ 100</button>
            </div>

            <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
              <input id="custom-amount" type="number" min="1" step="1" class="form-control" placeholder="Otro monto (USD)" style="max-width:180px;">
              <div id="paypal-donate-button" style="margin-left:8px;"></div>
              <!-- fallback donate button (old flow) -->
              <button id="donate-paypal" class="btn btn-primary" style="margin-left:8px;">Donar (fallback)</button>
            </div>

            <small class="muted-small">Si tu cuenta no acepta USD, usa el botón de transferencia bancaria o el QR para PLIN.</small>
          </div>

          <!-- Merch -->
          <div class="donate-panel">
            <h3 style="margin-top:0;">Tienda solidaria</h3>
            <p>Adquiere merch y recibe tu pedido. Los ingresos ayudan a financiar actividades de campo.</p>

            <div class="merch-grid" id="merch-grid">
              <div class="merch-card">
                <img src="images/merch_polo.jpg" alt="Polo IcTiosCusco">
                <div style="padding:14px; display:flex; flex-direction:column; gap:8px;">
                  <div><h4 style="margin:0">Polo IcTiosCusco</h4><p style="margin:0">$ 16</p></div>
                  <div style="display:flex; gap:8px; align-items:center;">
                    <input type="number" class="form-control merch-qty" data-id="polo" value="1" min="1" style="width:80px;">
                    <button class="btn btn-outline-primary btn-sm add-to-cart" data-id="polo" data-name="Polo IcTiosCusco" data-price="16">Agregar</button>
                  </div>
                </div>
              </div>

              <div class="merch-card">
                <img src="images/merch_tomatodo.jpg" alt="Tomatodo IcTiosCusco">
                <div style="padding:14px; display:flex; flex-direction:column; gap:8px;">
                  <div><h4 style="margin:0">Tomatodo</h4><p style="margin:0">$ 11</p></div>
                  <div style="display:flex; gap:8px; align-items:center;">
                    <input type="number" class="form-control merch-qty" data-id="botella" value="1" min="1" style="width:80px;">
                    <button class="btn btn-outline-primary btn-sm add-to-cart" data-id="botella" data-name="Tomatodo IcTiosCusco" data-price="11">Agregar</button>
                  </div>
                </div>
              </div>

              <div class="merch-card">
                <img src="images/merch_foto.jpg" alt="Foto IcTiosCusco">
                <div style="padding:14px; display:flex; flex-direction:column; gap:8px;">
                  <div><h4 style="margin:0">Foto 20x30 cm</h4><p style="margin:0">$ 32</p></div>
                  <div style="display:flex; gap:8px; align-items:center;">
                    <input type="number" class="form-control merch-qty" data-id="foto" value="1" min="1" style="width:80px;">
                    <button class="btn btn-outline-primary btn-sm add-to-cart" data-id="foto" data-name="Foto enmarcada IcTiosCusco" data-price="32">Agregar</button>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top:16px;">
              <div class="cart" id="cart">
                <h5 style="margin-top:0;">Carrito</h5>
                <div id="cart-rows"><p class="muted-small">No hay artículos en el carrito.</p></div>
                <div class="cart-total" id="cart-total">Total: $ 0</div>

                <div style="display:flex; gap:8px; margin-top:12px; align-items:center;">
                  <div id="paypal-cart-button"></div>
                  <button id="checkout-paypal" class="btn btn-primary">Pagar (fallback)</button>
                  <button id="order-mail" class="btn btn-outline-primary">Enviar pedido por correo</button>
                </div>

                <small class="muted-small d-block mt-2">Si PayPal no funciona, usa el QR para PLIN o la transferencia bancaria.</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Right column -->
        <div style="flex:0 1 360px; min-width:260px;">
          <div class="donate-panel">
            <h4 style="margin-top:0;">Contacto / Facturación</h4>
            <form id="donation-contact-form">
              <input name="name" class="form-control" placeholder="Tu nombre" required style="margin-bottom:8px;">
              <input name="email" type="email" class="form-control" placeholder="Tu correo" required style="margin-bottom:8px;">
              <input name="subject" type="text" class="form-control" placeholder="Asunto (p. ej. Donación / Pedido)" style="margin-bottom:8px;">
              <textarea name="message" class="form-control" rows="4" placeholder="Consulta o pedido" required style="margin-bottom:8px;"></textarea>
              <button type="submit" class="btn btn-primary">Enviar consulta</button>
              <div id="don-form-response" aria-live="polite" style="display:none; margin-top:8px;"></div>
            </form>

            <!-- QR para PLIN -->
            <div class="qr-box" aria-label="QR para PLIN">
              <!-- Reemplaza 'images/qr_plin.png' por tu archivo real del QR -->
              <a href="images/qr_plin.png" target="_blank" rel="noopener noreferrer" title="Abrir QR en tamaño completo">
                <img src="images/qr_plin.png" alt="QR PLIN IcTiosCusco" class="qr-img">
              </a>
              <div class="qr-caption">Escanea con tu app bancaria (PLIN / app móvil) para donar</div>
              <small style="display:block; margin-top:6px; color:#55686f;">Si tu banco no reconoce PLIN, comparte el comprobante a <a href="mailto:ictioscusco@gmail.com">ictioscusco@gmail.com</a>.</small>
            </div>
          </div>

          <div class="donate-panel" style="margin-top:18px;">
            <h5>¿Por qué donar?</h5>
            <ul>
              <li>Financiar muestreos de campo y redes de monitoreo.</li>
              <li>Soportar análisis genéticos y conservación de hábitat.</li>
              <li>Programas educativos con escuelas locales.</li>
            </ul>
          </div>
        </div>
      </div>

      <footer style="margin-top:28px; text-align:center; color:#55686f;">
        <p>IcTiosCusco — &copy; <span id="year"></span></p>
      </footer>
    </div>

    <!-- PayPal SDK (client-id: deja el tuyo o usa sandbox) -->
    <script src="https://www.paypal.com/sdk/js?client-id=AWMIl1fVzTcslis3zlHjT&currency=USD"></script>

    <script>
      document.getElementById('year').innerText = new Date().getFullYear();

      document.addEventListener('DOMContentLoaded', function () {
        // CONFIG
        const USE_SANDBOX = false; // true para pruebas sandbox
        const PAYPAL_SANDBOX_EMAIL = 'sb-opca146972674@business.example.com'; // sandbox example
        const PAYPAL_LIVE_EMAIL = 'ictioscusco@gmail.com';
        let PAYPAL_CURRENCY = 'USD';
        const PAYPAL_BUSINESS = USE_SANDBOX ? PAYPAL_SANDBOX_EMAIL : PAYPAL_LIVE_EMAIL;
        const PAYPAL_ENDPOINT = USE_SANDBOX ? 'https://www.sandbox.paypal.com/cgi-bin/webscr' : 'https://www.paypal.com/cgi-bin/webscr';
        if (USE_SANDBOX && document.getElementById('sandbox-note')) document.getElementById('sandbox-note').style.display='block';

        // Util
        function escapeHtml(text) { return (''+text).replace(/[&<>"']/g, function (m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]; }); }

        // CART logic (same as before)
        const cart = {};
        function addToCart(id, name, price, qty) {
          qty = Number(qty) || 1;
          if (cart[id]) cart[id].qty += qty;
          else cart[id] = { id, name, price: Number(price), qty };
          renderCart();
        }
        function removeFromCart(id) { delete cart[id]; renderCart(); }
        function renderCart() {
          const rows = document.getElementById('cart-rows');
          rows.innerHTML = '';
          const keys = Object.keys(cart);
          if (!keys.length) {
            rows.innerHTML = '<p class="muted-small">No hay artículos en el carrito.</p>';
            document.getElementById('cart-total').innerText = 'Total: $ 0';
            return;
          }
          let total = 0;
          keys.forEach(function (k) {
            const it = cart[k];
            total += it.price * it.qty;
            const div = document.createElement('div');
            div.className = 'cart-row';
            div.innerHTML = `
              <div>
                <strong>${escapeHtml(it.name)}</strong><br>
                <small>$ ${it.price.toFixed(2)} x ${it.qty}</small>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-danger remove-cart" data-id="${it.id}">Quitar</button>
              </div>
            `;
            rows.appendChild(div);
          });
          document.getElementById('cart-total').innerText = 'Total: $ ' + total.toFixed(2);
          document.querySelectorAll('.remove-cart').forEach(function (b) {
            b.addEventListener('click', function () { removeFromCart(this.getAttribute('data-id')); });
          });
        }
        document.querySelectorAll('.add-to-cart').forEach(function (btn) {
          btn.addEventListener('click', function () {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            const price = this.getAttribute('data-price');
            const qtyInput = document.querySelector('.merch-qty[data-id="' + id + '"]');
            const qty = qtyInput ? Number(qtyInput.value || 1) : 1;
            addToCart(id, name, price, qty);
          });
        });

        // ---------- PayPal Buttons (SDK) ----------
        if (typeof paypal !== 'undefined' && paypal.Buttons) {
          paypal.Buttons({
            style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'donate' },
            createOrder: function (data, actions) {
              const raw = Number(document.getElementById('custom-amount').value || 0);
              if (!raw || raw <= 0) { alert('Ingrese un monto válido para donar.'); throw new Error('Monto inválido'); }
              return actions.order.create({
                purchase_units: [{
                  amount: { currency_code: PAYPAL_CURRENCY, value: raw.toFixed(2) },
                  payee: { email_address: PAYPAL_BUSINESS },
                  description: 'Donación a IcTiosCusco'
                }]
              });
            },
            onApprove: function (data, actions) {
              return actions.order.capture().then(function (details) {
                alert('Gracias por tu donación, ' + (details.payer.name?.given_name || '') + '!');
                document.getElementById('custom-amount').value = '';
              });
            },
            onError: function (err) {
              console.error('PayPal donate error:', err);
              alert('Ocurrió un error con PayPal. Revisa la consola para más detalles.');
            }
          }).render('#paypal-donate-button');

          // Cart checkout button via SDK (optional)
          paypal.Buttons({
            style: { layout: 'horizontal', color: 'blue', shape: 'rect', label: 'checkout' },
            createOrder: function (data, actions) {
              const items = Object.values(cart);
              if (!items.length) { alert('El carrito está vacío.'); throw new Error('Carrito vacío'); }
              let itemTotal = 0;
              const purchaseItems = items.map(function (it) {
                const unit = Number(it.price).toFixed(2);
                itemTotal += Number(unit) * Number(it.qty);
                return { name: it.name, unit_amount: { currency_code: PAYPAL_CURRENCY, value: unit }, quantity: String(it.qty) };
              });
              return actions.order.create({
                purchase_units: [{
                  amount: {
                    currency_code: PAYPAL_CURRENCY,
                    value: itemTotal.toFixed(2),
                    breakdown: { item_total: { currency_code: PAYPAL_CURRENCY, value: itemTotal.toFixed(2) } }
                  },
                  items: purchaseItems,
                  payee: { email_address: PAYPAL_BUSINESS },
                  description: 'Compra tienda IcTiosCusco'
                }]
              });
            },
            onApprove: function (data, actions) {
              return actions.order.capture().then(function (details) {
                alert('Pago completado. ¡Gracias por tu compra, ' + (details.payer.name?.given_name || '') + '!');
                Object.keys(cart).forEach(k => delete cart[k]); renderCart();
              });
            },
            onError: function (err) {
              console.error('PayPal cart error:', err);
              alert('Error en PayPal. Revisa la consola.');
            }
          }).render('#paypal-cart-button');
        }

        // fallback donate button (old flow) - opens classic PayPal donations
        function createHidden(name, value) {
          const inp = document.createElement('input'); inp.type='hidden'; inp.name=name; inp.value=value; return inp;
        }
        function submitFormToNewWindow(form) {
          const win = window.open('', 'paypalWindow' + Math.floor(Math.random()*100000));
          if(!win) { alert('Tu navegador bloqueó la apertura de ventanas. Permite popups para este sitio e inténtalo de nuevo.'); return false; }
          form.target = win.name; document.body.appendChild(form); form.submit(); form.remove(); return true;
        }
        document.getElementById('donate-paypal').addEventListener('click', function () {
          const val = Number(document.getElementById('custom-amount').value || 0);
          if (!val || val <= 0) { alert('Ingresa un monto válido.'); return; }
          const form = document.createElement('form'); form.method='post'; form.action=PAYPAL_ENDPOINT; form.style.display='none';
          form.appendChild(createHidden('cmd','_donations'));
          form.appendChild(createHidden('business', PAYPAL_BUSINESS));
          form.appendChild(createHidden('item_name','Donación a IcTiosCusco'));
          form.appendChild(createHidden('amount', val.toFixed(2)));
          form.appendChild(createHidden('currency_code', PAYPAL_CURRENCY));
          form.appendChild(createHidden('return', window.location.href));
          form.appendChild(createHidden('cancel_return', window.location.href));
          if (!submitFormToNewWindow(form)) {
            const url = PAYPAL_ENDPOINT + '?cmd=_donations&business=' + encodeURIComponent(PAYPAL_BUSINESS) + '&amount=' + encodeURIComponent(val.toFixed(2)) + '&currency_code=' + encodeURIComponent(PAYPAL_CURRENCY);
            window.open(url, '_blank', 'noopener');
          }
        });

        // Cart fallback checkout (classic)
        document.getElementById('checkout-paypal').addEventListener('click', function () {
          if (!Object.keys(cart).length) { alert('El carrito está vacío. Agrega productos antes de pagar.'); return; }
          const form = document.createElement('form'); form.method='post'; form.action=PAYPAL_ENDPOINT; form.style.display='none';
          form.appendChild(createHidden('cmd','_cart')); form.appendChild(createHidden('upload','1')); form.appendChild(createHidden('business',PAYPAL_BUSINESS)); form.appendChild(createHidden('currency_code',PAYPAL_CURRENCY));
          let i=1; Object.values(cart).forEach(function(it){ form.appendChild(createHidden('item_name_'+i,it.name)); form.appendChild(createHidden('amount_'+i,it.price.toFixed(2))); form.appendChild(createHidden('quantity_'+i,it.qty)); i++; });
          form.appendChild(createHidden('return', window.location.href)); form.appendChild(createHidden('cancel_return', window.location.href));
          if (!submitFormToNewWindow(form)) { document.body.appendChild(form); form.submit(); form.remove(); }
        });

        // Order by email (Formspree)
        const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xqalnaaj';
        document.getElementById('order-mail').addEventListener('click', function () {
          if (!Object.keys(cart).length) { alert('El carrito está vacío. Agrega productos antes de enviar pedido.'); return; }
          const name = prompt('Nombre para el pedido (obligatorio):'); if (!name) return alert('Nombre requerido.');
          const email = prompt('Correo electrónico de contacto (obligatorio):'); if (!email) return alert('Correo requerido.');
          let msg = 'Pedido tienda IcTiosCusco:\n\n'; let total=0;
          Object.values(cart).forEach(function(it){ msg += `${it.name} — $ ${it.price.toFixed(2)} x ${it.qty}\n`; total += it.price * it.qty; });
          msg += `\nTotal aproximado: $ ${total.toFixed(2)}\n\nPor favor indicar método de pago y datos de envío.`;
          const data = new FormData(); data.append('name', name); data.append('email', email); data.append('subject', 'Pedido tienda — ' + name); data.append('message', msg);
          fetch(FORMSPREE_ENDPOINT, { method:'POST', headers:{ 'Accept':'application/json' }, body: data }).then(function (resp) {
            if (resp.ok) { alert('Pedido enviado. Te contactaremos por correo.'); Object.keys(cart).forEach(k => delete cart[k]); renderCart(); }
            else { alert('No se pudo enviar el pedido. Intenta luego o escríbenos a ictioscusco@gmail.com.'); }
          }).catch(function(){ alert('Error de conexión. Intenta luego o escríbenos a ictioscusco@gmail.com.'); });
        });

        // Contact form submit
        document.getElementById('donation-contact-form').addEventListener('submit', function (e) {
          e.preventDefault();
          const data = new FormData(this);
          fetch(FORMSPREE_ENDPOINT, { method:'POST', headers:{ 'Accept':'application/json' }, body: data }).then(function (resp) {
            if (resp.ok) { alert('Consulta enviada. Gracias, te contactaremos pronto.'); e.target.reset(); }
            else { alert('No se pudo enviar. Intenta nuevamente.'); }
          }).catch(function () { alert('Error de conexión. Intenta luego.'); });
        });

        // quick amount buttons set value
        document.querySelectorAll('.quick-amount').forEach(function (b) { b.addEventListener('click', function () { document.getElementById('custom-amount').value = this.getAttribute('data-amount'); }); });

        // init cart UI
        renderCart();
      });
    </script>

  </body>
</html>

