<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAC-FISH — IcTiosCusco (Eutrofizado + Truchas voraces)</title>

  <link href="https://fonts.googleapis.com/css?family=Dosis:200,300,400,500,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Overpass:300,400,400i,600,700" rel="stylesheet">
  <link rel="stylesheet" href="css/bootstrap.min.css">

  <style>
    body { background: linear-gradient(#e8fbf3,#dff6f0); }
    .game-wrap { max-width:1200px; margin:18px auto; padding:12px; background:rgba(255,255,255,0.95); border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.08); }
    #game-container { height:640px; position:relative; border-radius:8px; overflow:hidden; background:linear-gradient(#022,#013); }
    canvas { width:100%; height:100%; display:block; background:transparent; }
    .game-top { display:flex; gap:12px; align-items:center; margin-bottom:12px; z-index:20; position:relative; }
    .btn-back { margin-left:6px; }
    #overlay { position:absolute; left:12px; top:12px; color:white; z-index:16; text-shadow:0 2px 6px rgba(0,0,0,0.6); }
    #hud { position:absolute; right:12px; top:12px; color:white; z-index:16; text-align:right; display:flex; gap:8px; align-items:center; }
    #hud .hud-item { margin-left:8px; }
    #minimap { position:absolute; right:16px; bottom:16px; width:160px; height:140px; z-index:6; border-radius:999px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,0.25); background:rgba(0,0,0,0.12); display:flex; align-items:center; justify-content:center; }
    #mm { border-radius:999px; display:block; width:92%; height:92%; background:transparent; }
    #legendWrap { position:absolute; right:12px; bottom:310px; z-index:8; display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
    .legend { background: rgba(0,0,0,0.6); color:white; padding:8px 10px; border-radius:999px; font-size:0.82rem; display:flex; gap:10px; align-items:center; box-shadow:0 6px 14px rgba(0,0,0,0.35); }
    .sw { width:14px; height:10px; border-radius:3px; display:inline-block; border:1px solid rgba(255,255,255,0.08); }
    #hiddenBadge { position:absolute; left:12px; bottom:18px; color:#fff; background:rgba(0,0,0,0.4); padding:6px 8px; border-radius:8px; z-index:16; display:none; }
    .controls { display:flex; gap:8px; align-items:center; margin-left:auto; }
    @media (max-width:760px){ #game-container{ height:520px; } }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="images/logo.png" alt="IcTiosCusco" style="height:36px; margin-right:8px;">
        <span>IcTiosCusco</span>
      </a>
    </div>
  </nav>

  <main class="game-wrap">
    <div class="game-top">
      <h2 style="margin:0">PAC-FISH — Educación ambiental</h2>
      <div class="controls">
        <button id="fullBtn" class="btn btn-outline-secondary btn-sm">Pantalla completa</button>
        <a id="resBtn" class="btn btn-outline-primary btn-sm btn-back" href="recursos.html">← Volver a Recursos</a>
      </div>
    </div>

    <p style="margin:0 0 12px 0; color:#444;">
      Lee la mini-historia antes de cada nivel. Controles: mueve con el ratón o tocando la pantalla. Usa cuevas para esconderte. "Usar chance" te rescata una vez por nivel.
    </p>

    <div id="game-container">
      <canvas id="c"></canvas>
      <div id="overlay">Mov: ratón / tacto</div>

      <div id="hud">
        <div class="hud-item">Score: <strong id="score">0</strong></div>
        <div class="hud-item">Tamaño: <strong id="size">0</strong></div>
        <div class="hud-item">Hembras faltantes: <strong id="femaleRemain">0</strong></div>
        <div class="hud-item"><button id="chanceBtn" class="btn btn-warning btn-sm">Usar chance</button></div>
      </div>

      <div id="legendWrap">
        <div class="legend"><span class="sw" style="background:#a0e0ff"></span> Pejerrey H</div>
        <div class="legend"><span class="sw" style="background:#6fb7ff"></span> Pejerrey M</div>
        <div class="legend"><span class="sw" style="background:#c08f4a"></span> Carpa</div>
        <div class="legend"><span class="sw" style="background:#ff7b7b"></span> Trucha</div>
        <div class="legend"><span class="sw" style="background:#7ef78a"></span> Huevo</div>
        <div class="legend"><span class="sw" style="background:#333"></span> Cueva</div>
      </div>

      <div id="minimap"><canvas id="mm"></canvas></div>
      <div id="hiddenBadge">Escondido (cueva)</div>

      <div id="startOverlay" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; background:linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.55));">
        <div id="startBox" style="background:rgba(0,0,0,0.9); color:#fff; padding:20px 22px; border-radius:10px; max-width:720px; text-align:left;">
          <h3 id="briefTitle" style="margin-top:0">PAC-FISH — Antes de empezar</h3>
          <div id="briefText" style="margin-bottom:12px; color:#e9f6f0;"></div>
          <div style="display:flex; gap:8px;">
            <button id="btnStart" class="btn btn-success">Comenzar nivel</button>
            <button id="btnCancel" class="btn btn-outline-light">Cancelar</button>
          </div>
        </div>
      </div>

      <div id="message" style="position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:70;">
        <div style="background:rgba(0,0,0,0.7); color:white; padding:20px 22px; border-radius:10px; text-align:center;">
          <h3 id="msgTitle">Has muerto</h3>
          <div id="msgBody"></div>
          <div style="margin-top:12px;">
            <button id="respawn" class="btn btn-primary">Volver a jugar</button>
            <a class="btn btn-outline-light" href="recursos.html">Volver a Recursos</a>
          </div>
        </div>
      </div>

    </div>
  </main>

  <footer style="text-align:center; padding:12px 8px; color:#666;">
    <small>IcTiosCusco — Educación ambiental • © <span id="year"></span></small>
  </footer>

  <script>document.getElementById('year').innerText = new Date().getFullYear();</script>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>

  <script>
  (function(){
    // ---------- CONFIG ----------
    const SETTINGS = {
      worldW: 2400, worldH: 1600,
      pelletMass: 1.0,
      playerStartMass: 18,
      massToRadius: (m)=> Math.sqrt(m)*3,
      eatFactor: 0.65,
      troutAggroRange: 340,       // mayor rango de detección
      // velocidad base (ajustable)
      playerSpeedBase: 360,
      nativeSpeedBase: 150,
      troutSpeedBase: 190,        // truchas más rápidas
      pelletRespawn: true,
      troutEatGainMultiplier: 1.35 // truchas crecen más al comer
    };
    const REPRO_MIN_MASS = 400;
    const EGG_MAX = 8;
    const EGG_SPEED_BUFF = 1.6;
    const EGG_BUFF_TIME = 6.0;
    const CHANCE_INVULN = 6.0;

    function rand(a,b){ return a + Math.random()*(b-a); }
    function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
    function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }

    // ---------- sprites y orientación por sprite ----------
    // Si tu sprite "orestia.png" mira hacia la izquierda (es decir, su dibujo apunta a la izquierda),
    // pon -1. Si mira a la derecha, pon 1.
    const SPRITE_MAP = {
      orestia: 'orestia.png',
      pejerrey_F: 'pejerrey_f.png',
      pejerrey_M: 'pejerrey_m.png',
      trout: 'trout.png',
      carpa: 'carpa.png'
    };
    const SPRITE_FACE_DIRECTION = {
      // por defecto supongo que ORESTIA mira a la IZQUIERDA (-1).
      // Si tu Orestia apunta a la derecha, cambia este valor a 1.
      orestia: -1,
      pejerrey_F: 1,
      pejerrey_M: 1,
      trout: 1,
      carpa: 1
    };
    const SPRITES = {};
    for(const k in SPRITE_MAP){
      const img = new Image();
      img.src = 'images/' + SPRITE_MAP[k];
      SPRITES[k] = img;
    }

    // ---------- canvas ----------
    const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
    const mm = document.getElementById('mm'), mmCtx = mm.getContext('2d');

    // partículas para efecto eutrofia
    let algaeParticles = [];
    function initAlgae(){
      algaeParticles = [];
      for(let i=0;i<80;i++){
        algaeParticles.push({
          x: Math.random(),
          y: Math.random(),
          size: rand(4,18),
          speed: rand(0.005, 0.03),
          alpha: rand(0.06,0.22),
          sway: rand(0.2,1.6)
        });
      }
    }

    function resizeCanvas(){
      const rect = document.getElementById('game-container').getBoundingClientRect();
      canvas.width = Math.floor(rect.width);
      canvas.height = Math.floor(rect.height);
      mm.width = Math.floor(mm.clientWidth * devicePixelRatio);
      mm.height = Math.floor(mm.clientHeight * devicePixelRatio);
      camera.baseZoom = Math.min(1.1, Math.max(0.5, window.innerWidth/900));
    }
    window.addEventListener('resize', resizeCanvas);

    const world = { w: SETTINGS.worldW, h: SETTINGS.worldH };
    const camera = { x: world.w/2, y: world.h/2, baseZoom: Math.min(1.1, Math.max(0.5, window.innerWidth/900)), zoom:1 };

    // ---------- state ----------
    let player=null, pellets=[], natives=[], trouts=[], frogs=[];
    let caves = [], eggs = [];
    let running=false, paused=false, lastTime=performance.now(), mouse={x:0,y:0,worldX:0,worldY:0,down:false}, score=0;
    let currentLevelIndex=0, levelProgress={}, oxygen=100, pollutionZones=[];
    let chanceUsed = false;

    const LEVELS = [
      {
        id: 'urcos', name: 'Urcos',
        pelletCount: 700,
        composition: { pejerrey: 42, carpa: 14, trout: 0 },
        targets: { 'pejerrey_F': 10 },
        description: 'Urcos: Rolando Chaparrea sembró pejerreyes en la laguna. Debes crecer y eliminar 10 pejerreyes HEMBRA para frenar sus generaciones.'
      },
      {
        id: 'lucre', name: 'Lucre-Huacarpay',
        pelletCount: 600,
        composition: { pejerrey: 10, carpa: 40, trout: 10 },
        // nivel 2: lo que pediste: eliminar truchas y 10 hembras
        targets: { trout: 10, 'pejerrey_F': 10 },
        description: 'Lucre: truchas voraces han llegado. Debes eliminar 10 truchas y reducir 10 hembras de pejerrey.'
      },
      {
        id: 'titicaca', name: 'Lago Titicaca',
        pelletCount: 500,
        composition: { pejerrey: 10, carpa: 20, trout: 12 },
        // nivel 3: objetivo parecido para terminar el juego
        targets: { trout: 12, 'pejerrey_F': 12 },
        description: 'Titicaca: invasores voraces y contaminación. Sobrevive y elimina invasores para restaurar el ecosistema.'
      }
    ];

    // ---------- ENTIDADES ----------
    class Fish {
      constructor(x,y,mass,color,type='native',species='generic'){
        this.x=x; this.y=y; this.vx=0; this.vy=0; this.mass=mass; this.r=SETTINGS.massToRadius(this.mass);
        this.color=color; this.type=type; this.species=species; this.dead=false; this.reproCooldown=0;
        this.prefersPellets=false; this.sex=null; this.eggCooldown=0;
        this.facing = 1; this.facingTarget = 1;
      }
      updateRadius(){ this.r = SETTINGS.massToRadius(this.mass); }
      getSpeedBase(){ if(this.type==='player') return SETTINGS.playerSpeedBase; if(this.species==='trout') return SETTINGS.troutSpeedBase; return SETTINGS.nativeSpeedBase; }
      getSpeed(){
        const base=this.getSpeedBase();
        let s = base / (1 + Math.sqrt(this.mass)*0.05);
        if(this.species === 'pejerrey' && this.mass > 20){
          const reduce = Math.min(0.3, (this.mass - 20)/200);
          s *= (1 - reduce);
        }
        // truchas ligeramente más rápidas cuanto más grandes (voracidad)
        if(this.species === 'trout') s *= 1 + Math.min(0.6, (this.mass-18)/120);
        return s;
      }
      applyMovement(dx,dy,dt){
        const s=this.getSpeed();
        const len=Math.hypot(dx,dy)||1;
        const nx=dx/len, ny=dy/len;
        if(Math.abs(nx) > 0.25) this.facingTarget = Math.sign(nx);
        this.vx = nx*s; this.vy = ny*s;
        this.x += this.vx*dt; this.y += this.vy*dt;
        this.x = clamp(this.x, this.r+4, world.w - (this.r+4));
        this.y = clamp(this.y, this.r+4, world.h - (this.r+4));
      }
    }

    // pellets
    function spawnPellets(n){ for(let i=0;i<n;i++) pellets.push({ x:rand(20,world.w-20), y:rand(20,world.h-20), mass:SETTINGS.pelletMass, r:SETTINGS.massToRadius(SETTINGS.pelletMass), color:'#ffd54f' }); }

    // spawnNatives - CORRECCIÓN (evita manchas negras)
    function spawnNativesFromComposition(comp, levelId){
      Object.entries(comp).forEach(([spec,count])=>{
        if(spec === 'pejerrey' && levelId === 'urcos'){
          const femCount = Math.min(10, count);
          const sexes = [];
          for(let i=0;i<count;i++) sexes.push(i < femCount ? 'F' : 'M');
          for(let s = sexes.length - 1; s > 0; s--){ const r = Math.floor(Math.random()*(s+1)); const tmp = sexes[s]; sexes[s]=sexes[r]; sexes[r]=tmp; }
          for(let i=0;i<count;i++){
            const x=rand(60,world.w-60), y=rand(60,world.h-60);
            const mass = rand(8,22);
            const sex = sexes[i];
            const color = sex==='F' ? '#a0e0ff' : '#6fb7ff';
            const f = new Fish(x,y,mass,color,'native','pejerrey');
            f.sex = sex; f.vx = rand(-30,30); f.vy = rand(-30,30);
            natives.push(f);
          }
          return;
        }

        for(let i=0;i<count;i++){
          const x=rand(60,world.w-60), y=rand(60,world.h-60);
          const mass = spec==='carpa'? rand(18,40) : spec==='pejerrey'? rand(8,22) : rand(18,60);
          const color = spec==='carpa'? '#c08f4a' : spec==='pejerrey'? '#9ae0ff' : '#ff7b7b';
          const f = new Fish(x,y,mass,color,'native',spec);
          if(spec==='carpa') f.prefersPellets=true;
          if(spec==='pejerrey'){ f.sex = (Math.random() < 0.38) ? 'F' : 'M'; if(f.sex==='F') f.color = '#a0e0ff'; else f.color = '#6fb7ff'; }
          f.vx=rand(-30,30); f.vy=rand(-30,30);
          natives.push(f);
        }
      });
    }

    function spawnFrogs(n){ for(let i=0;i<n;i++) frogs.push({ x:rand(60,world.w-60), y:rand(60,world.h-60), r:8, mass:2, color:'#6bff7a', dead:false }); }
    function spawnCavesForLevel(levelId){ caves = []; const caveCount = (levelId==='urcos') ? 3 : (levelId==='lucre' ? 2 : 2); for(let i=0;i<caveCount;i++){ caves.push({ x: rand(120, world.w-120), y: rand(120, world.h-120), r: rand(40,72) }); } }
    function spawnEgg(x,y){ if(eggs.length >= EGG_MAX) return; eggs.push({ x, y, r:6, created: performance.now() }); }
    function createPlayer(){ player = new Fish(world.w/2, world.h/2, SETTINGS.playerStartMass, '#ffd54f','player','orestia'); player.updateRadius(); player.hidden=false; player.speedBuff=1; player.speedBuffTimer=0; player.invulnerable=false; player.facing=1; player.facingTarget=1; }

    // ---------- EATING (ajustada para trucha) ----------
    function tryEat(pred, prey){
      if(!prey || prey.dead) return false;

      // pejerrey vs player special
      if(pred.species === 'pejerrey' && prey.type === 'player' && pred.mass > player.mass * 1.05 && !player.invulnerable){
        const d = Math.hypot(pred.x - prey.x, pred.y - prey.y);
        if(d < pred.r * 0.95){
          prey.dead = true;
          // trucha obtiene más ganancia? aquí pred es pejerrey
          pred.mass += prey.mass * SETTINGS.eatFactor;
          pred.updateRadius();
          if(pred.type !== 'player') pred.reproCooldown = Math.max(0, pred.reproCooldown - 1);
          gameOver('Te comió un pejerrey grande');
          return true;
        }
        return false;
      }

      if(pred.r > prey.r * 1.08 && dist(pred,prey) < pred.r - prey.r*0.25){
        if(prey.type !== 'player' && prey.species === 'pejerrey' && prey.sex === 'F'){
          levelProgress['pejerrey_F'] = (levelProgress['pejerrey_F']||0) + 1;
        }
        prey.dead = true;
        // trout growth multiplier
        if(pred.species === 'trout'){
          pred.mass += prey.mass * SETTINGS.eatFactor * (SETTINGS.troutEatGainMultiplier || 1.0);
        } else {
          pred.mass += prey.mass * SETTINGS.eatFactor;
        }
        pred.updateRadius();
        if(pred.type !== 'player') pred.reproCooldown = Math.max(0, pred.reproCooldown - 1);
        if(pred.type === 'player') score += Math.round(prey.mass*2);
        if(pred.type !== 'player') checkRepro(pred);
        return true;
      }
      return false;
    }

    function tryEatPellet(f,i){
      const p = pellets[i];
      const d = Math.hypot(f.x-p.x, f.y-p.y);
      if(d < f.r - p.r*0.2){
        f.mass += p.mass * SETTINGS.eatFactor;
        f.updateRadius();
        pellets.splice(i,1);
        if(f.type==='player') score++;
        else f.reproCooldown = Math.max(0,f.reproCooldown-0.5);
        if(f.type!=='player') checkRepro(f);
        return true;
      }
      return false;
    }

    function tryEatEgg(f, idx){
      const e = eggs[idx];
      const d = Math.hypot(f.x - e.x, f.y - e.y);
      if(d < f.r + e.r*0.8){
        if(f.type === 'player'){ f.speedBuff = EGG_SPEED_BUFF; f.speedBuffTimer = EGG_BUFF_TIME; }
        eggs.splice(idx,1);
        return true;
      }
      return false;
    }

    function checkRepro(f){
      if(f.mass < REPRO_MIN_MASS) return;
      if(natives.length >= 300) return;
      if(f.reproCooldown > 0) return;
      const childMass = Math.max(4, Math.round(f.mass*0.36));
      const nx = clamp(f.x + rand(-40,40), 20, world.w-20);
      const ny = clamp(f.y + rand(-40,40), 20, world.h-20);
      const color = f.species==='carpa'? '#c08f4a' : f.species==='pejerrey'? (f.sex==='F' ? '#a0e0ff' : '#6fb7ff') : '#ff7b7b';
      const child = new Fish(nx,ny,childMass,color,'native',f.species);
      if(f.species==='pejerrey'){ child.sex = (Math.random() < 0.38) ? 'F' : 'M'; if(child.sex==='F') child.color='#a0e0ff'; else child.color='#6fb7ff'; }
      child.vx = rand(-10,10); child.vy = rand(-10,10);
      if(f.species==='carpa') child.prefersPellets = true;
      natives.push(child);
      f.mass = Math.max(6, f.mass*0.6);
      f.updateRadius();
      f.reproCooldown = 12 + Math.random()*12;
    }

    // ---------- AI updates (truchas agresivas) ----------
    function updateNatives(dt){
      for(let i=0;i<natives.length;i++){
        const n = natives[i];
        if(n.dead) continue;
        if(n.reproCooldown > 0) n.reproCooldown -= dt;
        if(n.eggCooldown > 0) n.eggCooldown -= dt;
        n.facing += (n.facingTarget - n.facing) * Math.min(1, dt*8);

        if(n.species === 'pejerrey' && n.sex === 'F' && n.mass > 18 && n.eggCooldown <= 0 && eggs.length < EGG_MAX && Math.random() < 0.012){
          const ex = clamp(n.x + rand(-180,180), 30, world.w-30);
          const ey = clamp(n.y + rand(-180,180), 30, world.h-30);
          spawnEgg(ex, ey);
          n.eggCooldown = 18 + Math.random()*30;
        }

        if(player && player.hidden){
          if(n.species === 'pejerrey' && n.mass > 14){
            n.applyMovement(n.x - player.x, n.y - player.y, dt*0.8);
            continue;
          } else {
            if(!n.target || Math.random() < 0.01) n.target = { x: n.x + rand(-220,220), y: n.y + rand(-220,220) };
            n.applyMovement(n.target.x - n.x, n.target.y - n.y, dt);
            continue;
          }
        }

        const shouldChasePlayer = (n.species === 'pejerrey' && n.mass > Math.max(20, player.mass * 1.05));
        if(shouldChasePlayer){
          n.applyMovement(player.x - n.x, player.y - n.y, dt);
          tryEat(n, player);
          continue;
        }

        // target selection
        let target = null, best = 1e9;
        for(let k=0;k<pellets.length;k++){
          const p = pellets[k];
          const d = Math.hypot(p.x - n.x, p.y - n.y);
          if(d < best && d < 420){ best = d; target = { type:'pellet', refIndex:k, x:p.x, y:p.y }; }
        }
        if(!target){
          for(let k=0;k<natives.length;k++){
            const other = natives[k];
            if(other.dead) continue;
            if(other.species === 'carpa'){
              const d = Math.hypot(other.x - n.x, other.y - n.y);
              if(d < best && d < 420){ best = d; target = { type:'fish', refIndex:k, x:other.x, y:other.y }; }
            }
          }
        }
        if(!target){
          for(let k=0;k<natives.length;k++){
            const other = natives[k];
            if(other.dead || other === n) continue;
            if(other.species === 'pejerrey' && n.mass > other.mass * 1.08){
              const d = Math.hypot(other.x - n.x, other.y - n.y);
              if(d < best && d < 420){ best = d; target = { type:'fish', refIndex:k, x:other.x, y:other.y }; }
            }
          }
        }

        if(target){
          n.applyMovement(target.x - n.x, target.y - n.y, dt);
          if(target.type === 'pellet'){
            for(let pI = pellets.length - 1; pI >= 0; pI--){
              if(Math.hypot(pellets[pI].x - n.x, pellets[pI].y - n.y) < n.r + 6){
                tryEatPellet(n, pI);
                break;
              }
            }
          } else if(target.type === 'fish'){
            const other = natives[target.refIndex];
            if(other && !other.dead){ if(tryEat(n, other)){ if(other.dead){ const idx = natives.indexOf(other); if(idx>=0) natives.splice(idx,1); } } }
          }
        } else {
          if(!n.target || Math.random() < 0.01) n.target = { x: n.x + rand(-220,220), y: n.y + rand(-220,220) };
          n.applyMovement(n.target.x - n.x, n.target.y - n.y, dt);
        }
      }
    }

    function updateTrouts(dt){
      for(let t of trouts){
        if(t.dead) continue;
        if(t.reproCooldown>0) t.reproCooldown -= dt;
        t.facing += (t.facingTarget - t.facing) * Math.min(1, dt*8);

        const dPlayer = Math.hypot(player.x-t.x, player.y-t.y);
        // AGRESIVA: persigue si está cerca, o si ya es relativamente grande
        if(dPlayer < SETTINGS.troutAggroRange || t.mass >= player.mass * 0.8){
          t.applyMovement(player.x-t.x, player.y-t.y, dt);
          tryEat(t, player);
        } else {
          let target=null, best=1e9;
          for(let f of frogs){ if(f.dead) continue; const d=Math.hypot(f.x-t.x,f.y-t.y); if(d<best){best=d;target=f;} }
          if(!target) for(let n of natives){ if(!n.dead && n.species!=='trout'){ const d=Math.hypot(n.x-t.x,n.y-t.y); if(d<best){best=d;target=n;} } }
          if(!target) for(let p of pellets){ const d=Math.hypot(p.x-t.x,p.y-t.y); if(d<best){best=d;target=p;} }
          if(target) t.applyMovement(target.x-t.x, target.y-t.y, dt);
          else { if(!t.target || Math.random()<0.005) t.target={x:t.x+rand(-240,240),y:t.y+rand(-240,240)}; t.applyMovement(t.target.x-t.x,t.target.y-t.y,dt); }
        }

        for(let i=pellets.length-1;i>=0;i--){ const eaten = tryEatPellet(t,i); if(eaten && SETTINGS.pelletRespawn) spawnPellets(1); }
        for(let i=natives.length-1;i>=0;i--){ const nat=natives[i]; if(!nat.dead && tryEat(t,nat)) natives.splice(i,1); }
        for(let j=frogs.length-1;j>=0;j--){ const fr=frogs[j]; if(fr.dead) continue; const d=Math.hypot(fr.x-t.x,fr.y-t.y); if(d < t.r + fr.r*0.5){ fr.dead=true; t.mass += fr.mass*SETTINGS.eatFactor* (SETTINGS.troutEatGainMultiplier || 1); t.updateRadius(); frogs.splice(j,1); } }
        checkRepro(t);
      }
    }

    function updatePlayer(dt){
      if(player.speedBuffTimer > 0){
        player.speedBuffTimer = Math.max(0, player.speedBuffTimer - dt);
        if(player.speedBuffTimer === 0) player.speedBuff = 1.0;
      }

      const tx = mouse.worldX || player.x, ty = mouse.worldY || player.y;
      const desiredDx = tx - player.x, desiredDy = ty - player.y;
      const sBase = SETTINGS.playerSpeedBase;
      const speed = (sBase / (1 + Math.sqrt(player.mass)*0.03)) * player.speedBuff;
      const len = Math.hypot(desiredDx,desiredDy) || 1;
      const nx = desiredDx/len;
      if(Math.abs(desiredDx) > 6) player.facingTarget = Math.sign(desiredDx); // threshold
      player.vx = nx*speed; player.vy = (desiredDy/len)*speed;
      player.x += player.vx * dt; player.y += player.vy * dt;
      player.x = clamp(player.x, player.r+4, world.w - (player.r+4));
      player.y = clamp(player.y, player.r+4, world.h - (player.r+4));
      player.facing += (player.facingTarget - player.facing) * Math.min(1, dt*8);

      for(let i=pellets.length-1;i>=0;i--) tryEatPellet(player,i);
      for(let i=eggs.length-1;i>=0;i--) tryEatEgg(player,i);

      for(let i=natives.length-1;i>=0;i--){
        const nat = natives[i];
        if(!nat.dead && tryEat(player, nat)) natives.splice(i,1);
      }
      for(let i=trouts.length-1;i>=0;i--){
        const t = trouts[i];
        if(tryEat(player, t)){ trouts.splice(i,1); setTimeout(()=> spawnTrouts(1, {x:player.x, y:player.y, r:120}), 3000); }
        else if(tryEat(t, player)){ gameOver('Te comió una trucha más grande'); return; }
      }

      player.hidden = false;
      for(const c of caves){ const d = Math.hypot(player.x - c.x, player.y - c.y); if(d < c.r - 6){ player.hidden = true; break; } }
      document.getElementById('hiddenBadge').style.display = player.hidden ? 'block' : 'none';
    }

    function spawnTrouts(n, safeZone){
      for(let i=0;i<n;i++){
        let tries=0;
        while(tries<500){
          tries++;
          const x=rand(60,world.w-60), y=rand(60,world.h-60);
          const dd = Math.hypot(x-safeZone.x, y-safeZone.y);
          if(dd > safeZone.r + 80){
            const mass = Math.random() < 0.3 ? rand(40,110) : rand(18,45);
            const t = new Fish(x,y,mass,'#ff7b7b','native','trout');
            t.vx = rand(-20,20); t.vy = rand(-20,20);
            trouts.push(t);
            break;
          }
        }
      }
    }

    // ---------- UPDATE (main) ----------
    function update(dt){
      if(!running || paused) return;
      camera.x = player.x; camera.y = player.y;

      // dynamic zoom: camera gets a bit farther as player grows
      const growth = Math.max(0, (player.mass - SETTINGS.playerStartMass) * 0.007);
      camera.zoom = clamp(camera.baseZoom * (1 - growth), 0.45, 1.4);

      const L = LEVELS[currentLevelIndex];

      if(L.id === 'titicaca'){
        for(let z of pollutionZones){ z.x += z.driftX*dt; z.y += z.driftY*dt; if(z.x<50||z.x>world.w-50) z.driftX *= -1; if(z.y<50||z.y>world.h-50) z.driftY *= -1; }
        let oxLoss = 0.02;
        for(let z of pollutionZones){ const d = Math.hypot(player.x - z.x, player.y - z.y); if(d < z.r) oxLoss += 0.3; }
        oxygen = clamp(oxygen - oxLoss*10*dt, 0, 100);
        if(oxygen <= 0){ gameOver('Moriste por falta de oxígeno'); return; }
      }

      // algae particle drift
      for(const p of algaeParticles){
        p.y -= p.speed * dt * 30;
        p.x += Math.sin(performance.now()*0.0004*p.sway) * 0.0006 * (1/p.size) * dt * 800;
        if(p.y < -0.08) { p.y = 1.08; p.x = Math.random(); }
        if(p.x < -0.2) p.x = 1.2; if(p.x > 1.2) p.x = -0.2;
      }

      updateNatives(dt);
      trouts = natives.filter(n=>n.species==='trout' && !n.dead);
      updateTrouts(dt);
      updatePlayer(dt);

      if(pellets.length < L.pelletCount && SETTINGS.pelletRespawn) spawnPellets(L.pelletCount - pellets.length);

      updateHUD();
      checkLevelComplete();
    }

    function checkLevelComplete(){
      const L = LEVELS[currentLevelIndex];
      const needed = Object.values(L.targets).reduce((a,b)=>a+b,0);
      const done = Object.values(levelProgress).reduce((a,b)=>a+b,0);
      if(done >= needed){
        running = false;
        document.getElementById('msgTitle').innerText = currentLevelIndex === LEVELS.length-1 ? 'Juego completado' : 'Nivel completado';
        document.getElementById('msgBody').innerText = 'Has cumplido el objetivo de ' + L.name + '. Puntaje: ' + score;
        document.getElementById('message').style.display = 'flex';
        setTimeout(()=>{ document.getElementById('message').style.display='none'; showBrief(Math.min(currentLevelIndex+1, LEVELS.length-1)); }, 1400);
      }
    }

    // ---------- RENDER (incluye efecto eutrofia) ----------
    function worldToScreen(x,y){ return { x: (x - camera.x)*camera.zoom + canvas.width/2, y: (y - camera.y)*camera.zoom + canvas.height/2 }; }

    function drawSprite(img, x, y, w, h, flip){
      if(!img || !img.complete || img.naturalWidth===0) return false;
      ctx.save();
      if(flip){
        ctx.translate(x + w/2, y + h/2);
        ctx.scale(-1,1);
        ctx.drawImage(img, -w/2, -h/2, w, h);
      } else {
        ctx.drawImage(img, x, y, w, h);
      }
      ctx.restore();
      return true;
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const L = LEVELS[currentLevelIndex];

      // background: bluish + subtle turbidity
      if(L.id === 'urcos' || L.id === 'titicaca'){
        const g = ctx.createLinearGradient(0,0,0,canvas.height);
        g.addColorStop(0, '#083a2f');
        g.addColorStop(1, '#02251f');
        ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);
      } else {
        const g = ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,'#012'); g.addColorStop(1,'#00121a'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
      }

      // eutrophicated swirl / bloom overlay
      ctx.save();
      ctx.globalCompositeOperation = 'lighter';
      for(let i=0;i<3;i++){
        const alpha = 0.02 + 0.01 * i;
        ctx.beginPath();
        ctx.fillStyle = `rgba(40,120,40,${alpha})`;
        const rx = (Math.sin(performance.now()*0.0003*(i+1))*0.5+0.5) * canvas.width;
        const ry = (Math.cos(performance.now()*0.0002*(i+1))*0.5+0.5) * canvas.height/2;
        ctx.ellipse(rx, ry+canvas.height*0.15*i, canvas.width*0.6/(i+1), canvas.height*0.18*(i+1), 0, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.restore();

      // algae particles (small green dots)
      ctx.save();
      for(const p of algaeParticles){
        const x = p.x * canvas.width;
        const y = p.y * canvas.height;
        ctx.beginPath();
        ctx.fillStyle = `rgba(90,200,110,${p.alpha})`;
        ctx.arc(x,y,p.size*camera.zoom*0.35,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();

      // caves
      for(const c of caves){
        const s = worldToScreen(c.x,c.y);
        ctx.beginPath(); ctx.fillStyle = 'rgba(6,6,6,0.6)'; ctx.arc(s.x, s.y, c.r*camera.zoom, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=2; ctx.arc(s.x,s.y,c.r*camera.zoom,0,Math.PI*2); ctx.stroke();
      }

      // pellets
      for(let p of pellets){ const s = worldToScreen(p.x,p.y); ctx.beginPath(); ctx.fillStyle = p.color; ctx.arc(s.x, s.y, p.r * camera.zoom, 0, Math.PI*2); ctx.fill(); }

      // eggs
      for(const e of eggs){ const s = worldToScreen(e.x,e.y); ctx.beginPath(); ctx.fillStyle = '#7ef78a'; ctx.arc(s.x,s.y,e.r*camera.zoom,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,0.12)'; ctx.arc(s.x-2,s.y-2, e.r*0.35*camera.zoom,0,Math.PI*2); ctx.fill(); }

      // natives (sprites or fallback)
      for(const n of natives){
        if(n.dead) continue;
        const s = worldToScreen(n.x,n.y);
        const size = Math.max(8, n.r*2*camera.zoom);
        // decide sprite key
        if(n.species === 'pejerrey'){
          const key = (n.sex==='F') ? 'pejerrey_F' : 'pejerrey_M';
          const img = SPRITES[key];
          const spriteFace = SPRITE_FACE_DIRECTION[key] || 1;
          const flip = (n.facing * spriteFace) < 0;
          if(img && img.complete && img.naturalWidth>0){ drawSprite(img, s.x - size/2, s.y - size/2, size, size, flip); }
          else { ctx.beginPath(); ctx.fillStyle = n.color; ctx.ellipse(s.x, s.y, n.r*1.15*camera.zoom, n.r*0.9*camera.zoom, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.fillStyle = (n.sex==='F' ? '#fff' : '#000'); ctx.arc(s.x + Math.max(2, n.r*0.25*camera.zoom), s.y - Math.max(2, n.r*0.25*camera.zoom), 2*camera.zoom, 0, Math.PI*2); ctx.fill(); }
        } else {
          const key = n.species === 'carpa' ? 'carpa' : (n.species==='trout' ? 'trout' : null);
          const img = key ? SPRITES[key] : null;
          const spriteFace = key ? (SPRITE_FACE_DIRECTION[key]||1) : 1;
          const flip = (n.facing * spriteFace) < 0;
          if(img && img.complete && img.naturalWidth>0){ drawSprite(img, s.x - size/2, s.y - size/2, size, size, flip); }
          else { ctx.beginPath(); ctx.fillStyle = n.color; ctx.ellipse(s.x, s.y, n.r*1.15*camera.zoom, n.r*0.9*camera.zoom, 0, 0, Math.PI*2); ctx.fill(); }
        }
      }

      // frogs
      for(const fr of frogs){ if(fr.dead) continue; const s = worldToScreen(fr.x,fr.y); ctx.beginPath(); ctx.fillStyle = fr.color; ctx.arc(s.x,s.y,fr.r*camera.zoom,0,Math.PI*2); ctx.fill(); }

      // player (orestia): use sprite orientation mapping
      const sp = worldToScreen(player.x, player.y);
      const psize = Math.max(10, player.r*2*camera.zoom);
      const pimg = SPRITES['orestia'];
      const spriteFaceP = SPRITE_FACE_DIRECTION['orestia'] || 1;
      const pflip = (player.facing * spriteFaceP) < 0;
      if(pimg && pimg.complete && pimg.naturalWidth>0){
        drawSprite(pimg, sp.x - psize/2, sp.y - psize/2, psize, psize, pflip);
      } else {
        ctx.beginPath(); ctx.fillStyle = player.color; ctx.ellipse(sp.x, sp.y, player.r*1.3*camera.zoom, player.r*0.95*camera.zoom, 0, 0, Math.PI*2); ctx.fill();
      }

      if(player.invulnerable){ ctx.beginPath(); ctx.strokeStyle = 'rgba(255,240,180,0.18)'; ctx.lineWidth = 8 * camera.zoom; ctx.arc(sp.x, sp.y, player.r*1.6*camera.zoom, 0, Math.PI*2); ctx.stroke(); }
      else if(player.speedBuff > 1){ ctx.beginPath(); ctx.strokeStyle = 'rgba(180,220,255,0.14)'; ctx.lineWidth = 6 * camera.zoom; ctx.arc(sp.x, sp.y, player.r*1.6*camera.zoom, 0, Math.PI*2); ctx.stroke(); }
    }

    function drawMinimap(){
      const w = mm.width, h = mm.height; mmCtx.clearRect(0,0,w,h); mmCtx.save(); mmCtx.fillStyle='rgba(0,0,0,0.1)'; mmCtx.fillRect(0,0,w,h);
      const sx = w / world.w, sy = h / world.h;
      for(let i=0;i<pellets.length;i+=Math.max(1,Math.floor(pellets.length/200))){ const p=pellets[i]; mmCtx.fillStyle='#ffd54f'; mmCtx.fillRect(p.x*sx - 1, p.y*sy - 1, 2, 2); }
      for(const n of natives){ if(n.dead) continue; mmCtx.fillStyle = n.species==='carpa'? '#c08f4a' : n.species==='pejerrey'? (n.sex==='F' ? '#a0e0ff' : '#6fb7ff') : '#ff7b7b'; mmCtx.fillRect(n.x*sx-2, n.y*sy-2, 4,4); }
      for(const e of eggs){ mmCtx.fillStyle = '#7ef78a'; mmCtx.fillRect(e.x*sx-2, e.y*sy-2, 3,3); }
      for(const c of caves){ mmCtx.fillStyle = '#333'; mmCtx.beginPath(); mmCtx.arc(c.x*sx, c.y*sy, Math.max(3, c.r*sx*0.35), 0, Math.PI*2); mmCtx.fill(); }
      mmCtx.fillStyle = '#fff0a8'; mmCtx.beginPath(); mmCtx.arc(player.x*sx, player.y*sy, Math.max(2, player.r*0.12), 0, Math.PI*2); mmCtx.fill();
      const vx = (camera.x - canvas.width/2/camera.zoom) * sx; const vy = (camera.y - canvas.height/2/camera.zoom) * sy;
      const vw = (canvas.width/camera.zoom) * sx; const vh = (canvas.height/camera.zoom) * sy;
      mmCtx.strokeStyle = 'rgba(255,255,255,0.5)'; mmCtx.lineWidth = 1; mmCtx.strokeRect(vx, vy, vw, vh);
      mmCtx.restore();
    }

    function updateHUD(){
      document.getElementById('score').innerText = score;
      document.getElementById('size').innerText = Math.round(player ? player.mass : 0);
      const L = LEVELS[currentLevelIndex];
      const femaleTarget = L.targets['pejerrey_F'] || 0;
      const killed = levelProgress['pejerrey_F'] || 0;
      document.getElementById('femaleRemain').innerText = Math.max(0, femaleTarget - killed);
    }

    function gameOver(reason){ running=false; document.getElementById('msgTitle').innerText='Has muerto'; document.getElementById('msgBody').innerText = reason + '. Puntaje: ' + score; document.getElementById('message').style.display = 'flex'; }

    // ---------- INPUT ----------
    canvas.addEventListener('mousemove',(e)=>{ const rect=canvas.getBoundingClientRect(); mouse.x=e.clientX-rect.left; mouse.y=e.clientY-rect.top; mouse.worldX = camera.x - canvas.width/2/camera.zoom + mouse.x/camera.zoom; mouse.worldY = camera.y - canvas.height/2/camera.zoom + mouse.y/camera.zoom; });
    canvas.addEventListener('mousedown', ()=> mouse.down=true);
    canvas.addEventListener('mouseup', ()=> mouse.down=false);
    canvas.addEventListener('touchstart',(e)=>{ mouse.down=true; mouse.x=e.touches[0].clientX; mouse.y=e.touches[0].clientY; mouse.worldX = camera.x - canvas.width/2/camera.zoom + mouse.x/camera.zoom; mouse.worldY = camera.y - canvas.height/2/camera.zoom + mouse.y/camera.zoom; e.preventDefault(); }, {passive:false});
    canvas.addEventListener('touchmove',(e)=>{ mouse.x=e.touches[0].clientX; mouse.y=e.touches[0].clientY; mouse.worldX = camera.x - canvas.width/2/camera.zoom + mouse.x/camera.zoom; mouse.worldY = camera.y - canvas.height/2/camera.zoom + mouse.y/camera.zoom; e.preventDefault(); }, {passive:false});
    canvas.addEventListener('touchend', ()=> mouse.down=false);

    // chance mechanic
    function useChance(){
      if(!running) return;
      if(chanceUsed) return;
      if(caves.length === 0) return;
      let best = null, bestD = 1e9;
      for(const c of caves){ const d = Math.hypot(player.x - c.x, player.y - c.y); if(d < bestD){ bestD = d; best = c; } }
      if(!best) return;
      player.x = best.x + 1; player.y = best.y + 1; player.hidden = true; player.invulnerable = true; chanceUsed = true;
      document.getElementById('chanceBtn').setAttribute('disabled','disabled');
      setTimeout(()=>{ player.invulnerable = false; player.hidden = true; }, CHANCE_INVULN * 1000);
    }
    document.getElementById('chanceBtn').addEventListener('click', useChance);

    // ---------- LIFECYCLE ----------
    function showBrief(idx){
      currentLevelIndex = idx;
      const L = LEVELS[idx];
      levelProgress = {};
      for(const k in L.targets) levelProgress[k]=0;
      spawnCavesForLevel(L.id);
      eggs = [];
      chanceUsed = false;
      document.getElementById('chanceBtn').removeAttribute('disabled');
      document.getElementById('briefTitle').innerText = 'Antes de: ' + L.name;
      document.getElementById('briefText').innerHTML = '<strong>Mini-historia educativa:</strong><br>' + L.description + '<br><em>Objetivo:</em> ' + Object.entries(L.targets).map(([k,v])=> v + ' × ' + k).join(', ') + '<p style="margin-top:6px;"><em>Historia:</em> Un poblador llamado <strong>Rolando Chaparrea</strong> sembró pejerreyes en la laguna. Ahora debes sobrevivir y frenar la sobrepoblación.</p>';
      document.getElementById('startOverlay').style.display='flex';
    }

    function startLevel(idx){
      const L = LEVELS[idx];
      pellets=[]; natives=[]; trouts=[]; frogs=[]; eggs=[]; score=0; oxygen=100; pollutionZones=[];
      chanceUsed = false;
      spawnPellets(L.pelletCount || 500);
      spawnNativesFromComposition(L.composition, L.id);
      spawnCavesForLevel(L.id);
      if(L.id==='lucre') spawnFrogs(18);
      if(L.id==='titicaca'){
        for(let i=0;i<6;i++) pollutionZones.push({ x:rand(200,world.w-200), y:rand(200,world.h-200), r:rand(80,160), driftX:rand(-10,10), driftY:rand(-10,10) });
      }
      trouts = natives.filter(n=>n.species==='trout');
      createPlayer();
      initAlgae();
      running=true; lastTime = performance.now(); requestAnimationFrame(loop);
      document.getElementById('startOverlay').style.display='none';
      document.getElementById('chanceBtn').removeAttribute('disabled');
    }

    function loop(now){
      const dt = Math.min(0.06, (now - lastTime)/1000);
      lastTime = now;
      update(dt); draw(); drawMinimap();
      requestAnimationFrame(loop);
    }

    // ---------- UI handlers ----------
    document.getElementById('fullBtn').addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); const container = document.getElementById('game-container'); if(!document.fullscreenElement){ if(container.requestFullscreen) container.requestFullscreen().catch(()=>{}); else if(container.webkitRequestFullscreen) container.webkitRequestFullscreen(); } else { if(document.exitFullscreen) document.exitFullscreen().catch(()=>{}); } });

    document.getElementById('btnStart').addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); startLevel(currentLevelIndex); });
    document.getElementById('btnCancel').addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); document.getElementById('startOverlay').style.display='none'; });
    document.getElementById('respawn').addEventListener('click', function(){ document.getElementById('message').style.display='none'; showBrief(0); });

    // ---------- INIT ----------
    resizeCanvas();
    mm.width = mm.clientWidth * devicePixelRatio; mm.height = mm.clientHeight * devicePixelRatio;
    showBrief(0);

    // expose for testing
    window.PACFISH = { startLevel, showBrief, LEVELS, SETTINGS };

  })();
  </script>

</body>
</html>
